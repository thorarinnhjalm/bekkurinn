rules_version = '2';

/**
 * Firestore Security Rules for Bekkurinn
 * 
 * Privacy-first architecture:
 * - Only class members can read class data
 * - Only admins can create/edit sensitive data
 * - Parent links require admin approval
 * - Phone visibility respects privacy toggles
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isAuthenticated() && 
             (request.auth.token.email == 'thorarinnhjalmarsson@gmail.com' || 
              request.auth.token.email == 'thorarinn@antigravity.is');
    }
    
    function isClassMember(classId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/parentLinks/$(request.auth.uid + '_' + classId));
    }
    
    function isClassAdmin(classId) {
      // Check if user is in the 'admins' array on the class document
      // OR if they have a parentLink with role 'admin' (e.g. Class Representative)
      return isAuthenticated() && (
             get(/databases/$(database)/documents/classes/$(classId)).data.admins.hasAny([request.auth.uid]) ||
             (exists(/databases/$(database)/documents/parentLinks/$(request.auth.uid + '_' + classId)) && 
              get(/databases/$(database)/documents/parentLinks/$(request.auth.uid + '_' + classId)).data.role == 'admin')
      );
    }

    // New Helper for School Admins (ForeldrafÃ©lag)
    function isSchoolAdmin(schoolId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/schools/$(schoolId)).data.admins.hasAny([request.auth.uid]);
    }
    
    // ========================================
    // USERS
    // ========================================
    
    match /users/{userId} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========================================
    // SCHOOLS
    // ========================================

    match /schools/{schoolId} {
      // Anyone can read basic school info (for onboarding)
      allow read: if isAuthenticated();
      
      // Only Super Admin can manage schools
      allow write: if isSuperAdmin();
    }

    // ========================================
    // CLASSES
    // ========================================
    
    match /classes/{classId} {
      // Allow read if Admin (checked on resource), SuperAdmin, or Member
      // LISTING: Allow authenticated users to read classes (for Join Code search)
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated();
      
      // Update/Delete requires Admin or SuperAdmin
      allow update, delete: if isSuperAdmin() || resource.data.admins.hasAny([request.auth.uid]) || isClassAdmin(classId);
    }
    
    // ========================================
    // STUDENTS
    // ========================================
    
    match /students/{studentId} {
      // Class members can read students in their class
      // ONBOARDING: Allow auth users to read (to select child)
      allow read: if isAuthenticated();
      
      // Parents can create student entries (pending admin approval via parentLinks)
      allow create: if isAuthenticated();
      
      // Only admins can update student details
      allow update: if isClassAdmin(resource.data.classId);
      
      // Only admins can delete students
      allow delete: if isClassAdmin(resource.data.classId);
    }
    
    // ========================================
    // PARENT LINKS (Junction Table)
    // ========================================
    
    // Helper to check if the current user is an APPROVED parent of the same student in the same class
    // This allows parents to approve/deny other parents for their own child
    function isParentOfStudent(classId, studentId) {
      let myLinkId = request.auth.uid + '_' + classId;
      return exists(/databases/$(database)/documents/parentLinks/$(myLinkId)) &&
             get(/databases/$(database)/documents/parentLinks/$(myLinkId)).data.studentId == studentId &&
             get(/databases/$(database)/documents/parentLinks/$(myLinkId)).data.status == 'approved';
    }

    match /parentLinks/{linkId} {
      // Users can read:
      // 1. Their own links
      // 2. Class Admins
      // 3. Parents of the SAME student (to see pending requests)
      allow read: if isAuthenticated() &&
                     (request.auth.uid == resource.data.userId || 
                      isClassAdmin(resource.data.classId) ||
                      isParentOfStudent(resource.data.classId, resource.data.studentId));
      
      // Users can create their own links
      allow create: if isAuthenticated() &&
                       request.auth.uid == request.resource.data.userId &&
                       linkId == request.resource.data.userId + '_' + request.resource.data.classId;

      // Users can update:
      // 1. Their own links (e.g. some profile setting?)
      // 2. Parents of the SAME student (to switch status from pending -> approved)
      // 3. Admins
      allow update: if isAuthenticated() && (
                       request.auth.uid == request.resource.data.userId || 
                       isParentOfStudent(resource.data.classId, resource.data.studentId) ||
                       isClassAdmin(resource.data.classId)
                    );
      
      // Users can delete:
      // 1. Their own links (e.g. leave class)
      // 2. Parents of the SAME student (to deny request)
      // 3. Admins
      allow delete: if isAuthenticated() &&
                       (request.auth.uid == resource.data.userId || 
                        isClassAdmin(resource.data.classId) ||
                        isParentOfStudent(resource.data.classId, resource.data.studentId));
    }
    
    // ========================================
    // TASKS (Patrol & Events)
    // ========================================
    
    match /tasks/{taskId} {
      // Read: Class members (for class tasks) or Authenticated users (if we want looser school event visibility)
      // Ideally, school events are visible to any parent in that school. 
      // Checking "member of school" is hard without storing schoolId on user or parentLink.
      // For now, let's allow read if authenticated for simplicity, or keep stricter:
      // Allow read if:
      // 1. isClassMember(classId) AND scope == 'class'
      // 2. scope == 'school' AND isAuthenticated() (assuming all auth users are parents)
      allow read: if isAuthenticated(); // Simplified for school scope support
      
      // Create:
      // 1. Class Admin (if scope 'class')
      // 2. School Admin (if scope 'school')
      allow create: if (
          (request.resource.data.scope == 'class' && isClassAdmin(request.resource.data.classId)) ||
          (request.resource.data.scope == 'school' && isSchoolAdmin(request.resource.data.schoolId))
      ) && request.resource.data.createdBy == request.auth.uid;
      
      // Update:
      // Class/School members can update (claim/unclaim slots)
      // Rules:
      // 1. Must be authenticated
      // 2. Must be class member (for class scope) OR authenticated (for school scope)
      // 3. Admins can update any field
      // 4. Regular members can only modify volunteers array (claim/unclaim)
      allow update: if isAuthenticated() && (
        // Admins can update anything
        (resource.data.scope == 'class' && isClassAdmin(resource.data.classId)) ||
        (resource.data.scope == 'school' && isSchoolAdmin(resource.data.schoolId)) ||
        // Class members can only update volunteers-related fields
        (resource.data.scope == 'class' && isClassMember(resource.data.classId) &&
          // Only allow changes to slotsFilled and volunteers
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['slotsFilled', 'volunteers'])
        ) ||
        // School scope - any auth user can claim slots
        (resource.data.scope == 'school' &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['slotsFilled', 'volunteers'])
        )
      );
      
      // Delete: Only admins
      allow delete: if (resource.data.scope == 'class' && isClassAdmin(resource.data.classId)) ||
                       (resource.data.scope == 'school' && isSchoolAdmin(resource.data.schoolId));
    }
    
    // ========================================
    // ANNOUNCEMENTS
    // ========================================
    
    match /announcements/{announcementId} {
      // Read: Similar to tasks, widespread read for school events
      allow read: if isAuthenticated();
      
      // Create:
      allow create: if (
          (request.resource.data.scope == 'class' && isClassAdmin(request.resource.data.classId)) ||
          (request.resource.data.scope == 'school' && isSchoolAdmin(request.resource.data.schoolId))
      ) && request.resource.data.createdBy == request.auth.uid;
      
      // Update/Delete: Only admins
      allow update, delete: if (resource.data.scope == 'class' && isClassAdmin(resource.data.classId)) ||
                               (resource.data.scope == 'school' && isSchoolAdmin(resource.data.schoolId));
    }
    
    // ========================================
    // PICKUP OFFERS
    // ========================================
    
    match /pickupOffers/{offerId} {
      // Read permissions:
      // 1. Offer creator can read
      // 2. Recipients (in sentToParents array) can read
      allow read: if isAuthenticated() && (
        resource.data.offeredBy == request.auth.uid ||
        resource.data.sentToParents.hasAny([request.auth.uid])
      );
      
      // Create permissions:
      // 1. Must be authenticated
      // 2. Must be offering for yourself (offeredBy == auth.uid)
      // 3. Must have valid classId
      allow create: if isAuthenticated() && 
                       request.resource.data.offeredBy == request.auth.uid &&
                       request.resource.data.classId != null &&
                       request.resource.data.isActive == true &&
                       request.resource.data.acceptances.size() == 0; // Start with empty acceptances
      
      // Update permissions:
      // 1. Offer creator can update (e.g., cancel by setting isActive = false)
      // 2. Recipients can update ONLY to add their acceptance to the array
      allow update: if isAuthenticated() && (
        // Creator can update (cancel offer)
        (resource.data.offeredBy == request.auth.uid) ||
        
        // Recipient can accept: only modifying acceptances array
        (resource.data.sentToParents.hasAny([request.auth.uid]) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['acceptances']) &&
         request.resource.data.acceptances.size() > resource.data.acceptances.size() && // Only adding
         request.resource.data.acceptances.size() <= request.resource.data.availableSlots) // Respect slots limit
      );
      
      // Delete permissions: Only creator can delete
      allow delete: if isAuthenticated() && resource.data.offeredBy == request.auth.uid;
    }
    
    // ========================================
    // LOST & FOUND ITEMS
    // ========================================
    
    match /lostItems/{itemId} {
      // Read: Anyone authenticated (class or school wide)
      allow read: if isAuthenticated();
      
      // Create: Authenticated users
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      
      // Update: Creator or admins
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        (resource.data.scope == 'class' && isClassAdmin(resource.data.classId)) ||
        (resource.data.scope == 'school' && isSchoolAdmin(resource.data.schoolId))
      );
      
      // Delete: Creator or admins
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        (resource.data.scope == 'class' && isClassAdmin(resource.data.classId)) ||
        (resource.data.scope == 'school' && isSchoolAdmin(resource.data.schoolId))
      );
    }
    
    // ========================================
    // NOTIFICATIONS
    // ========================================

    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Users can update (mark as read) their own notifications
      allow update: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid; // Cannot change owner

      // Notification creation rules:
      // 1. Users can create notifications for themselves
      // 2. Super admins can create for anyone
      // Note: Ideally this would be Cloud Functions, but for MVP we allow controlled client creation
      allow create: if isAuthenticated() && (
        // Create for yourself
        request.resource.data.userId == request.auth.uid ||
        // Super admin can create for anyone
        isSuperAdmin()
      );

      // Users can delete their notifications
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // TESTIMONIALS
    // ========================================

    match /testimonials/{testimonialId} {
      // Read permissions:
      // 1. Anyone can read approved testimonials (for public display)
      // 2. Users can read their own testimonials
      // 3. Super admins can read all
      allow read: if resource.data.status == 'approved' ||
                     (isAuthenticated() && resource.data.userId == request.auth.uid) ||
                     isSuperAdmin();

      // Create: Authenticated users can create testimonials for themselves
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.status == 'pending'; // Must start as pending

      // Update: Only super admins can update (approve/reject)
      allow update: if isSuperAdmin();

      // Delete: Super admins or the creator (if still pending)
      allow delete: if isSuperAdmin() ||
                       (isAuthenticated() &&
                        resource.data.userId == request.auth.uid &&
                        resource.data.status == 'pending');
    }

    // ========================================
    // CONTACT MESSAGES
    // ========================================

    match /contactMessages/{messageId} {
      // Anyone can create a contact message (even unauthenticated for flexibility)
      allow create: if true;

      // Only super admins can read and manage messages
      allow read, update, delete: if isSuperAdmin();
    }
  }
}
