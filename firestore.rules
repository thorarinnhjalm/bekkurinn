rules_version = '2';

/**
 * Firestore Security Rules for Bekkurinn
 * 
 * Privacy-first architecture:
 * - Only class members can read class data
 * - Only admins can create/edit sensitive data
 * - Parent links require admin approval
 * - Phone visibility respects privacy toggles
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isAuthenticated() && 
             (request.auth.token.email == 'thorarinnhjalmarsson@gmail.com' || 
              request.auth.token.email == 'thorarinn@antigravity.is');
    }
    
    function isClassMember(classId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/parentLinks/$(request.auth.uid + '_' + classId));
    }
    
    function isClassAdmin(classId) {
      // Use GET for cross-document checks (when checking permission on students/tasks)
      return isAuthenticated() &&
             get(/databases/$(database)/documents/classes/$(classId)).data.admins.hasAny([request.auth.uid]);
    }
    
    // ========================================
    // USERS
    // ========================================
    
    match /users/{userId} {
      allow read, write: if isSuperAdmin();
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // ========================================
    // CLASSES
    // ========================================
    
    match /classes/{classId} {
      // Allow read if Admin (checked on resource), SuperAdmin, or Member
      // This enables list queries: where('admins', 'array-contains', uid)
      allow read: if isSuperAdmin() || 
                     resource.data.admins.hasAny([request.auth.uid]) ||
                     isClassMember(classId);
      
      allow create: if isAuthenticated();
      
      // Update/Delete requires Admin or SuperAdmin
      allow update, delete: if isSuperAdmin() || resource.data.admins.hasAny([request.auth.uid]);
    }
    
    // ========================================
    // STUDENTS
    // ========================================
    
    match /students/{studentId} {
      // Class members can read students in their class
      allow read: if isClassMember(resource.data.classId);
      
      // Parents can create student entries (pending admin approval via parentLinks)
      allow create: if isAuthenticated();
      
      // Only admins can update student details
      allow update: if isClassAdmin(resource.data.classId);
      
      // Only admins can delete students
      allow delete: if isClassAdmin(resource.data.classId);
    }
    
    // ========================================
    // PARENT LINKS (Junction Table)
    // ========================================
    
    match /parentLinks/{linkId} {
      // Users can read their own links
      allow read: if isAuthenticated() &&
                     (request.auth.uid == resource.data.userId || 
                      isClassAdmin(resource.data.classId));
      
      // Users can create links (any status for now to allow auto-approve MVP logic)
      allow create: if isAuthenticated() &&
                       request.auth.uid == request.resource.data.userId &&
                       linkId == request.resource.data.userId + '_' + request.resource.data.classId;
      
      // Only admins can approve links (only update status)
      allow update: if isClassAdmin(resource.data.classId) &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'approvedAt', 'approvedBy']) &&
                       request.resource.data.status == 'approved';
      
      // Users can delete their own pending links, admins can delete any
      allow delete: if isAuthenticated() &&
                       (request.auth.uid == resource.data.userId || 
                        isClassAdmin(resource.data.classId));
    }
    
    // ========================================
    // TASKS (Patrol & Events)
    // ========================================
    
    match /tasks/{taskId} {
      // Class members can read tasks
      allow read: if isClassMember(resource.data.classId);
      
      // Only admins can create tasks
      allow create: if isClassAdmin(request.resource.data.classId) &&
                       request.resource.data.createdBy == request.auth.uid;
      
      // Class members can update tasks (for claiming slots)
      // But only via specific functions
      allow update: if isClassMember(resource.data.classId);
      
      // Only admins can delete tasks
      allow delete: if isClassAdmin(resource.data.classId);
    }
    
    // ========================================
    // ANNOUNCEMENTS
    // ========================================
    
    match /announcements/{announcementId} {
      // Class members can read announcements
      allow read: if isClassMember(resource.data.classId);
      
      // Only admins can create announcements
      allow create: if isClassAdmin(request.resource.data.classId) &&
                       request.resource.data.createdBy == request.auth.uid;
      
      // Only admins can update announcements
      allow update: if isClassAdmin(resource.data.classId);
      
      // Only admins can delete announcements
      allow delete: if isClassAdmin(resource.data.classId);
    }
  }
}
